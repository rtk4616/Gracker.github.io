<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="google-site-verification" content="" />
  
  <title>Android内存优化之二：MAT使用进阶</title>
  <meta name="author" content="Gracker">
   <meta name="description" content="专注 Android 性能优化">
  

  <meta property="og:title" content="Android内存优化之二：MAT使用进阶"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:site_name" content="Performance"/>
 <meta property="og:image" content="undefined"/>
  
  <link href="/apple-touch-icon-precomposed.png" sizes="180x180" rel="apple-touch-icon-precomposed">
  <link rel="alternate" href="/atom.xml" title="Performance" type="application/atom+xml">
  <link rel="stylesheet" href="//cdn.bootcss.com/bootstrap/3.3.6/css/bootstrap.min.css">
  <link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="/css/m.min.css">
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
</head>

<body>
  <div id='wx_pic' style='display:none;'><img src='/wx_share.png'/></div>
  <div id="main">
    <div class="behind">
      <div class="back">
        <a href="/" class="black-color"><i class="fa fa-times" aria-hidden="true"></i></a>
      </div>
      <div class="description">
        &nbsp;True mastery of any skill takes a lifetime
      </div>
    </div>
    <div class="container">
      

  <article class="standard post">
    <div class="title">
      
  
    <h1 class="page-title center">
        Android内存优化之二：MAT使用进阶
    </h1>
  


    </div>
    <div class="meta center">
      
<time datetime="2015-04-11T10:26:36.000Z">
  <i class="fa fa-calendar"></i>&nbsp;
  2015-04-11
</time>



    
    &nbsp;
    <i class="fa fa-tag"></i>&nbsp;
    <a href="/categories/Android/">Android</a>·<a href="/categories/Android/Menory/">Menory</a>




    
    &nbsp;
    <i class="fa fa-tag"></i>&nbsp;
    <a href="/tags/Android/">Android</a>·<a href="/tags/MAT/">MAT</a>·<a href="/tags/Performance/">Performance</a>·<a href="/tags/Menory/">Menory</a>


    </div>
    <hr>
    <div class="picture-container">
      
    </div>
    <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>第一篇文章<a href="http://androidperformance.com/2015/04/11/AndroidMemory-Usage-Of-MAT/">《Android内存优化之一：MAT使用入门》</a>介绍了MAT的基本使用方法，包括下载、安装、打开HPROF文件，和一些基本的视图。这篇文章介绍一下一些最新的工具使用方法，和第一篇中没有提到的一些其他的用法。</p>
<h2 id="Java的内存泄露的特点"><a href="#Java的内存泄露的特点" class="headerlink" title="Java的内存泄露的特点"></a>Java的内存泄露的特点</h2><ul>
<li>Java中的内存泄露主要特征：可达，无用</li>
<li>无用指的是创建了但是不再使用之后没有释放</li>
<li>能重用但是却创建了新的对象进行处理</li>
</ul>
<h2 id="MAT使用技巧进阶"><a href="#MAT使用技巧进阶" class="headerlink" title="MAT使用技巧进阶"></a>MAT使用技巧进阶</h2><h3 id="使用Android-Studio-Dump内存文件"><a href="#使用Android-Studio-Dump内存文件" class="headerlink" title="使用Android Studio Dump内存文件"></a>使用Android Studio Dump内存文件</h3><p>Android Studio的最新版本可以直接获取hprof文件：</p>
<p><img src="/images/MAT_Pro/MAT_1.png" alt="Android-Studio"></p>
<a id="more"></a>
<p>然后选择文件，点击右键转换成标准的hprof文件，就可以在MAT中打开了。</p>
<blockquote>
<p>在使用使用Eclipse或者AndroidStudio抓内存之前，一定要手动点击 Initiate GC按钮手动触发GC，这样抓到的内存使用情况就是不包括Unreachable对象的。</p>
<p><img src="/images/MAT_Pro/MAT_2.png" alt="手动触发GC"></p>
</blockquote>
<h3 id="Unreachable对象"><a href="#Unreachable对象" class="headerlink" title="Unreachable对象"></a>Unreachable对象</h3><p>Unreachable指的是可以被垃圾回收器回收的对象，但是由于没有GC发生，所以没有释放，这时抓的内存使用中的Unreachable就是这些对象。</p>
<p><img src="/images/MAT_Pro/MAT_3.png" alt="Unreachable Objects"></p>
<p><img src="/images/MAT_Pro/MAT_4.png" alt="Unreachable Objects Histogram"></p>
<p>点击Calculate Retained Size之后，会出现Retained Size这一列</p>
<p><img src="/images/MAT_Pro/MAT_5.png" alt="Calculate Retained Size"></p>
<p><img src="/images/MAT_Pro/MAT_6.png" alt="Unreachable Objects Histogram"></p>
<p>可以看到Unreachable Object的对象其Retained Heap值都为0.这也是正常的。</p>
<h3 id="Histogram"><a href="#Histogram" class="headerlink" title="Histogram"></a>Histogram</h3><p>MAT中Histogram的主要作用是查看一个instance的数量，一般用来查看自己创建的类的实例的个数。</p>
<ul>
<li>可以很容易的找出占用内存最多的几个对象，根据Percentage（百分比）来排序。</li>
<li>可以分不同维度来查看对象的Dominator Tree视图，Group by class、Group by class  loader、Group by package<br>和Histogram类似，时间久了，通过多次对比也可以把溢出对象找出来。</li>
<li>Dominator Tree和Histogram的区别是站的角度不一样，Histogram是站在类的角度上去看，Dominator Tree是站的对象实例的角度上看，Dominator Tree可以更方便的看出其引用关系。</li>
</ul>
<p><img src="/images/MAT_Pro/MAT_7.png" alt="Histogram group by package"></p>
<p>通过查看Object的个数，结合代码就可以找出存在内存泄露的类（<strong>即可达但是无用的对象，或者是可以重用但是重新创建的对象</strong>）</p>
<p>Histogram中还可以对对象进行Group，更方便查看自己Package中的对象信息。</p>
<p><img src="/images/MAT_Pro/MAT_8.png" alt="Paste_Image.png"></p>
<h3 id="Thread信息"><a href="#Thread信息" class="headerlink" title="Thread信息"></a>Thread信息</h3><p>MAT中可以查看当前的Thread信息：</p>
<p><img src="/images/MAT_Pro/MAT_9.png" alt="Thread"></p>
<p>从图中可以得到的信息：</p>
<ol>
<li><p>可以看到可能有内存问题的Thread：</p>
<p><img src="/images/MAT_Pro/MAT_10.png" alt="内存异常"></p>
</li>
<li><p>可以看到数量可能有问题的Thread</p>
<p><img src="/images/MAT_Pro/MAT_11.png" alt="数量异常"></p>
</li>
</ol>
<h3 id="帮助信息"><a href="#帮助信息" class="headerlink" title="帮助信息"></a>帮助信息</h3><p>MAT中的各个视图中，在每一个Item中点击右键会出现很多选项，很多时候我们需要依赖这些选项来进行分析：</p>
<p><img src="/images/MAT_Pro/MAT_12.png" alt="右键选项"></p>
<p>这些选项的具体含义则可以通过右键中的Search Queries这个选项(上图中的倒数第四个选项)进行搜索和查看，非常的有用。</p>
<p><img src="/images/MAT_Pro/MAT_13.png" alt="帮助信息"></p>
<p>可以看到，所有的命令其实就是配置不同的SQL查询语句。</p>
<p>比如我们最常用的：</p>
<ul>
<li><strong>List objects -&gt; with incoming references</strong>：查看这个对象持有的外部对象引用</li>
<li><strong>List objects -&gt; with outcoming references</strong>：查看这个对象被哪些外部对象引用</li>
<li><strong>Path To GC Roots -&gt; exclude all phantim/weak/soft etc. references</strong>：查看这个对象的GC Root，不包含虚、弱引用、软引用，剩下的就是强引用。从GC上说，除了强引用外，其他的引用在JVM需要的情况下是都可以 被GC掉的，如果一个对象始终无法被GC，就是因为强引用的存在，从而导致在GC的过程中一直得不到回收，因此就内存溢出了。</li>
<li><strong>Path To GC Roots  -&gt; exclude weak/soft references</strong>：查看这个对象的GC Root，不含弱引用和软引用所有的引用.</li>
<li><strong>Merge Shortest path to GC root </strong>：找到从GC根节点到一个对象或一组对象的共同路径</li>
</ul>
<h3 id="Debug-Bitmap"><a href="#Debug-Bitmap" class="headerlink" title="Debug Bitmap"></a>Debug Bitmap</h3><p>如果经常使用MAT分析内存，就会发现Bitmap所占用的内存是非常大的，这个和其实际显示面积是有关系的。在2K屏幕上，一张Bitmap能达到20MB的大小。</p>
<p>所以要是MAT提供了一种方法，可以将存储Bitmap的byte数组导出来，使用第三方工具打开。这个大大提高了我们分析内存泄露的效率。</p>
<p>关于这个方法的操作流程，可以参考这篇文章<a href="http://www.androidperformance.com/2015/04/11/AndroidMemory-Open-Bitmap-Object-In-MAT.html" target="_blank" rel="external">还原MAT中的Bitmap图像</a>.<br>I</p>
<h3 id="Debug-ArrayList"><a href="#Debug-ArrayList" class="headerlink" title="Debug ArrayList"></a>Debug ArrayList</h3><p>ArrayList是使用非常常用的一个数据结构，在MAT中，如果想知道ArrayList中有哪些数据，需要右键-&gt; List Objects -&gt; With outgoing references,然后可以看到下面的图：</p>
<p><img src="/images/MAT_Pro/MAT_14.png" alt="Outgoing"></p>
<p>从上图可以看到，这个ArrayList的内容在一个array数组中，即暴漏了ArrayList的内部结构，查看的时候有点不方便，所以MAT提供了另外一种查看ArrayList内数据的方式：</p>
<p><img src="/images/MAT_Pro/MAT_15.png" alt="Extrace List Values"></p>
<p>其结果非常直观：</p>
<p><img src="/images/MAT_Pro/MAT_16.png" alt="Extrace List Values Result"></p>
<h3 id="Big-Drops-In-Dominator-Tree"><a href="#Big-Drops-In-Dominator-Tree" class="headerlink" title="Big Drops In Dominator Tree"></a>Big Drops In Dominator Tree</h3><p>Big Drops In Dominator Tree选项在右键-&gt;</p>
<blockquote>
<p>Displays memory accumulation points in the dominator tree. Displayed are objects with a big difference between the retained size of the parent and the children and the first “interesting” dominator of the accumulation point. These are places where the memory of many small objects is accumulated under one object.</p>
</blockquote>
<p><img src="/images/MAT_Pro/MAT_17.png" alt="Big Drops In Dominator Tree"></p>


  </article>
  </script>
    <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
  </script>
  <div class="busuanzi center">
    页阅读量:&nbsp;<span id="busuanzi_value_page_pv"></span>&nbsp;・&nbsp;
    站访问量:&nbsp;<span id="busuanzi_value_site_pv"></span>&nbsp;・&nbsp;
    站访客数:&nbsp;<span id="busuanzi_value_site_uv"></span>
  </div>




    </div>
  </div>
  <footer class="page-footer"><div class="clearfix">
</div>
<div class="right-foot container">
    <div class="firstrow">
        <a href="#top" >
        <i class="fa fa-arrow-right"></i>
        </a>
        © XXX 2015-2016
    </div>
    <div class="secondrow">
        <a href="https://github.com/gaoryrt/hexo-theme-pln">
        Theme Pln
        </a>
    </div>
</div>
<div class="clearfix">
</div>
</footer>
  <script src="//cdn.bootcss.com/jquery/2.2.1/jquery.min.js"></script>
<script src="/js/search.js"></script>
<script type="text/javascript">

// comments below to disable loading animation
function revealOnScroll() {
  var scrolled = $(window).scrollTop();
  $(".excerpt, .index-title, .index-meta, p").each(function() {
    var current = $(this),
      height = $(window).outerHeight(),
      offsetTop = current.offset().top;
    (scrolled + height + 50 > offsetTop) ? current.addClass("animation"):'';
  });
}
$(window).on("scroll", revealOnScroll);
$(document).ready(revealOnScroll)

// disqus scripts


// dropdown scripts
$(".dropdown").click(function(event) {
  var current = $(this);
  event.stopPropagation();
  $(current).children(".dropdown-content")[($(current).children(".dropdown-content").hasClass("open"))?'removeClass':'addClass']("open")
});
$(document).click(function(){
    $(".dropdown-content").removeClass("open");
})

// back to top scripts
$("a[href='#top']").click(function() {
  $("html, body").animate({ scrollTop: 0 }, 500);
  return false;
});


var path = "/search.xml";
searchFunc(path, 'local-search-input', 'local-search-result');

</script>

</body>
</html>
