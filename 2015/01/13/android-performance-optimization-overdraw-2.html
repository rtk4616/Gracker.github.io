<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="google-site-verification" content="" />
  
  <title>Android性能优化之过渡绘制( 二)</title>
  <meta name="author" content="Gracker">
   <meta name="description" content="专注 Android 性能优化">
  

  <meta property="og:title" content="Android性能优化之过渡绘制( 二)"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:site_name" content="Performance"/>
 <meta property="og:image" content="undefined"/>
  
  <link href="/apple-touch-icon-precomposed.png" sizes="180x180" rel="apple-touch-icon-precomposed">
  <link rel="alternate" href="/atom.xml" title="Performance" type="application/atom+xml">
  <link rel="stylesheet" href="//cdn.bootcss.com/bootstrap/3.3.6/css/bootstrap.min.css">
  <link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="/css/m.min.css">
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
</head>

<body>
  <div id='wx_pic' style='display:none;'><img src='/wx_share.png'/></div>
  <div id="main">
    <div class="behind">
      <div class="back">
        <a href="/" class="black-color"><i class="fa fa-times" aria-hidden="true"></i></a>
      </div>
      <div class="description">
        &nbsp;True mastery of any skill takes a lifetime
      </div>
    </div>
    <div class="container">
      

  <article class="standard post">
    <div class="title">
      
  
    <h1 class="page-title center">
        Android性能优化之过渡绘制( 二)
    </h1>
  


    </div>
    <div class="meta center">
      
<time datetime="2015-01-13T11:38:53.000Z">
  <i class="fa fa-calendar"></i>&nbsp;
  2015-01-13
</time>



    
    &nbsp;
    <i class="fa fa-tag"></i>&nbsp;
    <a href="/categories/Android/">Android</a>





    </div>
    <hr>
    <div class="picture-container">
      
    </div>
    <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>上一篇<a href="http://www.androidperformance.com/android-performance-optimization-overdraw-1.html" target="_blank" rel="external">文章</a>从理论的角度讲解了一下什么是过渡绘制，以及可以用来查看和确认过渡绘制的工具，还提供了一些优化过渡绘制的方法。对代码和布局比较熟悉的人，看完上一篇其实就已经可以对自己的应用进行优化了。我记得有人说过，用iphone你只需要保证苹果有节操即可，用Android你就得保证所有的Android开发者都有节操。但现实是残酷的，现在Android市场上，有很多粗制滥造的应用，其中不乏大厂之作，各位打开过渡绘制按钮，就知道我所言非虚。作为一个Android开发人员，我肯定是更希望Android能一步一步好起来，超越iphone。</p>
<p>这篇文章从实战的角度，讲解了一个过渡绘制的优化过程。当然这里用到的只是很少的一部分，毕竟每个应用差别很大，优化方式也各不一样。所以这篇文章仅供参考，想把这块做好还是要下功夫的。</p>
<p>如果没有看过前一篇，可以点这里：<a href="http://androidperformance.com/2014/10/20/android-performance-optimization-overdraw-1.html">Android性能优化之过渡绘制(一)</a></p>
<hr>
<a id="more"></a>
<h2 id="定位过渡绘制区域"><a href="#定位过渡绘制区域" class="headerlink" title="定位过渡绘制区域"></a>定位过渡绘制区域</h2><h3 id="打开GPU过渡绘制选项"><a href="#打开GPU过渡绘制选项" class="headerlink" title="打开GPU过渡绘制选项:"></a>打开GPU过渡绘制选项:</h3><p>设置—辅助功能–开发人员工具–硬件加速渲染—调试GPU过渡绘制— 显示过渡绘制区域.</p>
<h3 id="清理后台"><a href="#清理后台" class="headerlink" title="清理后台"></a>清理后台</h3><p>Kill掉(即清后台)要测试的应用,重新打开就可以看到效果.下面以文件管理器和设置为例子,如下图</p>
<p><img src="/images/overdraw-1/filemanager-1.png" alt="文件管理器"><img src="/images/overdraw-1/settings.png" alt="设置"></p>
<p>从图上可以看出,按照过渡绘制从好到坏(蓝-绿-粉红-红)来看,文件管理器的过渡绘制是非常严重的,而设置界面的过渡绘制则在可以接受的范围内.下面就以文件管理器为主要分析对象,来看看如何对文件管理器的过渡绘制进行优化.</p>
<h3 id="从文件管理器的图-分析出过渡绘制区域"><a href="#从文件管理器的图-分析出过渡绘制区域" class="headerlink" title="从文件管理器的图,分析出过渡绘制区域:."></a>从文件管理器的图,分析出过渡绘制区域:.</h3><ul>
<li>首先看最上面的ActionBar和最下面的SmartBar,对比设置界面的ActionBar就可以知道,整个文件管理器存在一个不透明的背景,导致每次绘制时,都要先绘制这个看不见且不透明的背景.这个背景一般是应用的主题自带的背景,所以GPU过渡绘制显示其位蓝色,这个背景是可以进行优化的.</li>
<li>中间的内容部分,最底层是绿色,说明进行了2x的过渡绘制,去掉第一条我们提的那个全局背景,还有一层背景,也就是1x的过渡绘制,对比setting可知,这个背景色也是可以去掉的.</li>
<li>最容易看出的是这两条,我们先分析和优化这两条,然后再进行其他的优化.</li>
</ul>
<h2 id="优化过渡绘制区域"><a href="#优化过渡绘制区域" class="headerlink" title="优化过渡绘制区域"></a>优化过渡绘制区域</h2><p>在进行位置确认后，我们大概确定了过渡绘制的区域,让我们来使用工具来进行验证和View确认.</p>
<p>打开Monitor(Eclipse和Android Studio中都有快捷打开按钮,即DDMS,右上角选择 Hierarchy View,大概使用如图</p>
<p><img src="/images/overdraw-1/HierarchyView-1.png" alt="Hierarchy View"></p>
<p>其中根节点:PhoneWindos$DecorView是整个视图的根节点,唯一的子节点是ActionBarOverlayLayout,这个Layout包含了ActionBar,应用程序,以及SmartBar.</p>
<p>下面讲述如何从Hierarchy View结合代码分析出需要进行修改的区域</p>
<h3 id="去除默认背景"><a href="#去除默认背景" class="headerlink" title="去除默认背景"></a>去除默认背景</h3><p>上面分析过渡绘制区域的第一条,整个window存在一个背景,所以进行了一次重绘,这个背景的重绘是系统级别的,和主题有关,即这个背景是属于ActionBarOverlayLayout的.这种类型的过渡绘制解决也比较方便,在文件管理器的主Activity的onCreate方法中,加入</p>
<p><code>this.getWindow().setBackgroundDrawableResource(android.R.color.transparent);</code></p>
<p>就可以将这个看不见的主题背景去掉.下面是去掉主题背景后的效果图(一张是划开,一张是没有划开):</p>
<p><img src="/images/overdraw-1/filemanager-2.png" alt="文件管理器"><img src="/images/overdraw-1/filemanager-3.png" alt="文件管理器"></p>
<p>对比优化前的图可以发现,背景被去掉之后,少了一层过渡绘制. ActionBar上的蓝色已经消失了.中间的内容由绿色变为蓝色</p>
<h3 id="消除子控件背景"><a href="#消除子控件背景" class="headerlink" title="消除子控件背景"></a>消除子控件背景</h3><p>上面分析的第二条说”<strong>中间的内容部分,最底层是绿色,说明进行了2x的过渡绘制</strong>”,现在中间部分变成了蓝色,但是这是一个全局的背景,导致右边的view拉过来之后,还是存在大量的红色和绿色. 继续分析Hierarchy View,找到中间view对应的视图:DragRelativeLayout,查看源码可知,DragRelativeLayout继承自公共控件:SlidingMenu ，SlidingMenu 由CustomViewAbove和CustomViewBehind组成,前者是上面可以左右拉动的那部分,后者是底部不能拉动的那部分(这个从HierarchyView中也可以看出来:如下图所示:</p>
<p><img src="/images/overdraw-1/HierarchyView-2.png" alt="Hierarchy View"></p>
<p>点击CustomViewBehind,查看其所占的区域,就可以发现背景是这个View进行绘制的,打开CustomViewBehind的代码可以发现其构造函数中包含下面的代码:<br><code>setBackgroundColor(getResources().getColor(R.color.mz_slidingmenu_background_light));</code><br>这个背景是不需要的,查看源码可知,这个view会在SlidingMenu.setMenu的时候,被覆盖掉,还是看不到的.所以这一层view是可以去掉的.下面是去掉一层背景之后的预览图:</p>
<p><img src="/images/overdraw-1/filemanager-4.png" alt="文件管理器"><img src="/images/overdraw-1/filemanager-5.png" alt="文件管理器"></p>
<p>可以看到这一层背景去掉之后,过渡绘制减轻了很多.</p>
<h3 id="进一步优化"><a href="#进一步优化" class="headerlink" title="进一步优化"></a>进一步优化</h3><p>接着进行分析,可以看到CustomViewAbove也是存在一个过渡绘制的背景的,查看Hierarchy View的CustomViewAbove的子节点,可以看到过渡绘制是由ListView导致的.其id为:FilesList,在代码中找到它,并对他进行分析.在我将PartitionItemLayout中onDraw()函数的setBounds去掉之后,过渡绘制进一步改善了(但是ListItem的View的颜色也比之前要浅了,这一步优化需要根据具体情况进行) 下面是优化后的效果图:</p>
<p><img src="/images/overdraw-1/filemanager-6.png" alt="文件管理器"><img src="/images/overdraw-1/filemanager-7.png" alt="文件管理器"></p>
<p>可以看到图中的过渡绘制已经非常少了.!点个赞!</p>
<hr>
<h2 id="优化代码"><a href="#优化代码" class="headerlink" title="优化代码"></a>优化代码</h2><h3 id="Lint工具"><a href="#Lint工具" class="headerlink" title="Lint工具"></a>Lint工具</h3><p>Lint工具的使用比较简单,根据给出的提示做对应的修改即可.有时候需要工具具体情况来确定是否需要修改. 下图是一个简单地例子.箭头处提示这个Layout或者它的父Layout是不必须的.具体修改方法即去掉FrameLayout,将RelativeLayout提升为根VIew即可.</p>
<p><img src="/images/overdraw-1/lint-1.png" alt="Lint"></p>
<p>Lint工具还会针对代码中潜在的不合理或者Bed Code做出修改意见.比较重要的提示包括</p>
<ul>
<li>声明但是没有使用的变量</li>
<li>可能会产生的空指针</li>
<li>没必要书写的return,continue</li>
<li>复杂代码的简化写法</li>
<li>for循环的简化写法:foreach</li>
<li>无效的判空</li>
<li>空if</li>
<li>无效或者未使用的import</li>
</ul>
<h3 id="使用Tracer-For-OpenGL-ES"><a href="#使用Tracer-For-OpenGL-ES" class="headerlink" title="使用Tracer For OpenGL ES"></a>使用Tracer For OpenGL ES</h3><p>Tracer工具也在Android Device Monitor中.点击右上角的Tracer for OpenGL ES按钮就可以进入(如果没有这个按钮,点击旁边的Open Perspective按钮,从选项中选择Tracer for OpenGL ES即可).初次打开Tracer工具,里面是没有内容的,点击右上角的两个按钮(一个是打开现有的GLTrace文件,另一个是新建GLTrace文件)。点击Trace按钮, 手机会自动启动应用程序并启动对应的Activity,当手机上的内容完全绘制出来之后,就可以点击Stop按钮,生成GlTrace文件.文件会自动打开.</p>
<p><img src="/images/overdraw-1/Tracer-1.png" alt="Tracer"></p>
<p>分析GLTrace文件，下图是优化过后的图,对比优化前的图可以发现,优化后不会去绘制默认的背景图和CustomViewBehind的背景图.</p>
<p><img src="/images/overdraw-1/Tracer-2.png" alt="Tracer"></p>
<p>这只是一帧的绘制,如果多操作几下生成多个帧的绘制trace文件,会发现这两个背景会被多次的重绘,去掉后不仅会减轻过渡绘制,也会加快GUP的绘制速度.</p>
<hr>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ol>
<li><a href="http://www.curious-creature.org/2012/12/01/android-performance-case-study/" target="_blank" rel="external">优化过程</a></li>
<li><a href="http://blog.csdn.net/yihongyuelan/article/details/12169647" target="_blank" rel="external">反编译并添加gpu显示</a></li>
<li><a href="http://developer.android.com/training/improving-layouts/optimizing-layout.html#Inspect" target="_blank" rel="external">http://developer.android.com/training/improving-layouts/optimizing-layout.html#Inspect</a></li>
<li><a href="http://developer.android.com/training/improving-layouts/reusing-layouts.html" target="_blank" rel="external">http://developer.android.com/training/improving-layouts/reusing-layouts.html </a></li>
<li><a href="http://developer.android.com/training/improving-layouts/loading-ondemand.html" target="_blank" rel="external">http://developer.android.com/training/improving-layouts/loading-ondemand.html</a></li>
<li><a href="http://developer.android.com/training/improving-layouts/smooth-scrolling.html" target="_blank" rel="external">http://developer.android.com/training/improving-layouts/smooth-scrolling.html </a></li>
<li><a href="http://developer.android.com/tools/help/hierarchy-viewer.html" target="_blank" rel="external">http://developer.android.com/tools/help/hierarchy-viewer.html</a></li>
<li><a href="http://tools.android.com/tips/lint" target="_blank" rel="external">http://tools.android.com/tips/lint</a></li>
</ol>
<hr>
<blockquote>
<p>作者：<a href="http://weibo.com/1315612820/profile?topnav=1&amp;wvr=6" target="_blank" rel="external">Gracker</a></p>
<p>出处：<a href="http://androidperformance.com/2015/01/13/android-performance-optimization-overdraw-2/">androidperformance.com</a></p>
<p>本文版权归作者所有，欢迎转载，但未经作者同意必须保留此段声明，且在文章页面明显位置给出原文连接，否则保留追究法律责任的权利。</p>
<p>打赏一下： <a href="http://weibo.com/p/1001603801588257955883?from=page_100505_profile&amp;wvr=6&amp;mod=wenzhangmod" target="_blank" rel="external">微博打赏</a></p>
</blockquote>


  </article>
  </script>
    <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
  </script>
  <div class="busuanzi center">
    页阅读量:&nbsp;<span id="busuanzi_value_page_pv"></span>&nbsp;・&nbsp;
    站访问量:&nbsp;<span id="busuanzi_value_site_pv"></span>&nbsp;・&nbsp;
    站访客数:&nbsp;<span id="busuanzi_value_site_uv"></span>
  </div>




    </div>
  </div>
  <footer class="page-footer"><div class="clearfix">
</div>
<div class="right-foot container">
    <div class="firstrow">
        <a href="#top" >
        <i class="fa fa-arrow-right"></i>
        </a>
        © XXX 2015-2016
    </div>
    <div class="secondrow">
        <a href="https://github.com/gaoryrt/hexo-theme-pln">
        Theme Pln
        </a>
    </div>
</div>
<div class="clearfix">
</div>
</footer>
  <script src="//cdn.bootcss.com/jquery/2.2.1/jquery.min.js"></script>
<script src="/js/search.js"></script>
<script type="text/javascript">

// comments below to disable loading animation
function revealOnScroll() {
  var scrolled = $(window).scrollTop();
  $(".excerpt, .index-title, .index-meta, p").each(function() {
    var current = $(this),
      height = $(window).outerHeight(),
      offsetTop = current.offset().top;
    (scrolled + height + 50 > offsetTop) ? current.addClass("animation"):'';
  });
}
$(window).on("scroll", revealOnScroll);
$(document).ready(revealOnScroll)

// disqus scripts


// dropdown scripts
$(".dropdown").click(function(event) {
  var current = $(this);
  event.stopPropagation();
  $(current).children(".dropdown-content")[($(current).children(".dropdown-content").hasClass("open"))?'removeClass':'addClass']("open")
});
$(document).click(function(){
    $(".dropdown-content").removeClass("open");
})

// back to top scripts
$("a[href='#top']").click(function() {
  $("html, body").animate({ scrollTop: 0 }, 500);
  return false;
});


var path = "/search.xml";
searchFunc(path, 'local-search-input', 'local-search-result');

</script>

</body>
</html>
