<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="专注 Android 性能优化"><title>How PNG Works | Performance</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.1"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/6.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create','UA-50993302-2','auto');ga('send','pageview');</script></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">How PNG Works</h1><a id="logo" href="/.">Performance</a><p class="description">True mastery of any skill takes a lifetime</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">How PNG Works</h1><div class="post-meta">Apr 7, 2016<script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span></div><div class="clear"><div id="toc" class="toc-article"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Understanding-the-Compression"><span class="toc-number">1.</span> <span class="toc-text">Understanding the Compression</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-Filtering-prediction"><span class="toc-number">1.1.</span> <span class="toc-text">1 Filtering (prediction)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-Compression-DEFLATE"><span class="toc-number">1.2.</span> <span class="toc-text">2 Compression (DEFLATE)</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Understanding-the-format"><span class="toc-number">2.</span> <span class="toc-text">Understanding the format</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Pixel-format"><span class="toc-number">3.</span> <span class="toc-text">Pixel format</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Story-GIF-and-the-birth-of-PNG"><span class="toc-number">4.</span> <span class="toc-text">Story : GIF and the birth of PNG</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#In-closing"><span class="toc-number">5.</span> <span class="toc-text">In closing</span></a></li></ol></div></div><div class="post-content"><p>原文地址：<a href="https://medium.com/@duhroach/how-png-works-f1174e3cc7b7#.b923t7n34" target="_blank" rel="external">https://medium.com/@duhroach/how-png-works-f1174e3cc7b7#.b923t7n34</a><br>原文作者：<a href="https://medium.com/@duhroach" target="_blank" rel="external">Colt McAnlis</a></p>
<p>The Portable Network Graphics (PNG) has become a staple for App development over the past few decades. It’s creeped up everywhere from game development, to web development, and Android development, which means that it’s widely adopted, but also has the opportunity to be widely abused.</p>
<p>And as I’ve discussed before, PNG provides a nice, high resolution image format, but that means that there’s lots of room for improvement for data compression. But before we can start talking about how to compress PNG files further, we have to first talk about how the format works.</p>
<a id="more"></a>
<p><img src="/images/media/14600331177923.jpg" alt=""></p>
<h1 id="Understanding-the-Compression"><a href="#Understanding-the-Compression" class="headerlink" title="Understanding the Compression"></a>Understanding the Compression</h1><p>PNG’s compression process is entirely lossless; meaning that the compressed file can reconstruct the source image exactly. Done in two stages: Prediction (aka filtering) and then Compression.</p>
<h2 id="1-Filtering-prediction"><a href="#1-Filtering-prediction" class="headerlink" title="1 Filtering (prediction)"></a>1 Filtering (prediction)</h2><p>Delta encoding is one of the most powerful numeric compression methods out there. The basic idea is that you can represent any value as a difference from the previous value. So,</p>
<p>[2,3,4,5,6,7,8] can become [2,1,1,1,1,1,1], where<br>[2, 3–2=1, 4–3=1, 5–4=1, 6–5=1, 7–6=1, 8–7=1]</p>
<p>The reason this is so powerful, is that if the data is linearly correlated (that is, value has some low-difference from the previous value) then you end up transforming values of your dataset into lots of duplicate, low values, which are more compressible.</p>
<p>The PNG format makes use of delta encoding in a format that it calls “filtering”. Basically, for each scan-line of pixels, a current pixel is encoded in some relation to the pixel to the left, the pixel above, and the pixel above-left.</p>
<p><img src="/images/media/14600331929796.jpg" alt=""></p>
<p>For example if we encoded a given pixel by listing its difference between the average of A and B (X-((A+B)/2)then we’d get:</p>
<p><img src="/images/media/14600332058049.jpg" alt=""></p>
<p>The filtering takes ABC, and uses that to predict what the value of x is. The value that we replace x with, is the difference between the prediction, and the actual value.</p>
<p>Now, it’s worth noting that each line may be a little different, which is why PNG allows 1 of 5 different modes to be chosen, per line:</p>
<ul>
<li>No filtering</li>
<li>Difference between X and A</li>
<li>Difference between X and B</li>
<li>Difference between X and (A + B)/2 (aka average)</li>
<li>Paeth predictor (linear function of A,B,C)</li>
</ul>
<p>The intention here, is that each line can choose the best filtering method, for itself, such that it can produce the lowest number of unique symbols. Here’s our original example with each mode:</p>
<p><img src="/images/media/14600333696105.jpg" alt="An example of applying filtering to two rows of pixel values. The impacted pixels are highlighted in blue."></p>
<p>An example of applying filtering to two rows of pixel values. The impacted pixels are highlighted in blue.<br>And, it’s important to note that these filters are done, per channel not per-pixel. Meaning that the filter is applied to all the red values of a pixel for a scanline, and then separately for all the blue values for a scanline (although all the colors in a row will use the same filter).</p>
<p>And the PNG format has some nifty ways to pick which filter to use on a channel; While brute force is the most direct, it’s simply right out. Instead, the developers experimented on different image types and came up with some rules of thumb, that are close to optimal; like use None filters for palette images, and sub-8 bit grayscale images. And for the other images, choose the filter that minimizes the sum of absolute differences; Rather than using modulo-256, instead to standard signed math, then take the abs value, and add them all together for a given row, and compare the sums for the other filter types. Choose the filter that gives the smallest sum.</p>
<h2 id="2-Compression-DEFLATE"><a href="#2-Compression-DEFLATE" class="headerlink" title="2 Compression (DEFLATE)"></a>2 Compression (DEFLATE)</h2><p>Once filtering has occurred on a scan-line, it’s passed off to a descendant of the LZ77 algorithm, known as DEFLATE; This algorithm combines LZ77 coding alongside a Huffman coder. Which is almost identical to compressors like PKWARE, PKZIP, GZip etc. The implementation is out-of-the-box standard, but has some interesting caveats when it comes to image data.</p>
<ol>
<li>Deflate limits match lengths between 3 and 258 symbols; which puts the maximum conceivable compression ratio around 1032:1.</li>
<li>If the match is less than 3 symbols, then you incur some overhead to represent the symbol</li>
</ol>
<p>The result of these two, means that the size of your image can have an impact in if matches are found in a scanline.</p>
<p>Consider this image below, The 270x90 version is only 20k, however the 270x92 version is 2x larger.</p>
<p><img src="/images/media/14600334859301.jpg" alt=""></p>
<p>Logically this seems wrong. Adding 540 pixels to an image shouldn’t cause a 2x bloat in compression. However when we look a little closer, we can see why this is occurring; The following heat map of the images represents how compressed a given pixel is. Deep blue = very compressed, yellow/red = not very compressed</p>
<p><img src="/images/media/14600335437808.jpg" alt=""></p>
<p>What’s occurring here, is that in the smaller image, there’s more matches in the scanlines, and thus there’s better compression. However, adjusting the size, slightly, changes the type of matching that can occur; some potential candidates for matching are now outside of our LZ window, and thus aren’t matched, resulting in a larger file.</p>
<p>If you’re looking to see how well your own images compressed with PNG, check out PNGThermal.</p>
<h1 id="Understanding-the-format"><a href="#Understanding-the-format" class="headerlink" title="Understanding the format"></a>Understanding the format</h1><p>Now, it’s worth noting that PNG is more than just the filtering &amp; compression stages. It’s a pretty extensible container format, that can support all sorts of image types and added data.</p>
<p>Let’s first start with the fact that the PNG file format can support a series of chunks inside of it which can include various types of data. For example, you’ve got the PNG Header chunk which contains simple information about the image like width, height, bit depth &amp; color-type.</p>
<p>The Image data chunk contains the actual image information itself (oh, and note, this information can exist in multiple chunks). Then for color paletted images, there’s a separate chunk for that.</p>
<p>And finally an end-of-file chunk. And those are the main chunks, but there’s also a whole slew of other chunks like:</p>
<ul>
<li>Default background color</li>
<li>Chroma coordinates on how to display white-points</li>
<li>Gamma spec</li>
<li>Histogram info</li>
<li>Text data, with language or Metadata info</li>
<li>Color space information</li>
<li>Stereo-image data</li>
<li>A chunk which notes the last time the file was changed</li>
<li>And Transparency data.</li>
</ul>
<p>Now, these chunks are where you need to watch out, because lots of junk gets put in there by your photo editing app. For example, saving a PNG file from Photoshop results in a chunk that says “this image was made in photoshop.” That chunk has nothing to do with the visible pixel data, but yet it’s included in the file itself. As such, REMOVING useless chunks is critical to ensuring small file sizes. The image below shows you a 16x16 pixel image, saved from Photoshop as a regular PNG, and the other-one, using the “export to web” option of photoshop, which removes all the gobbledygook.</p>
<p><img src="/images/media/14600330550488.jpg" alt="The left image was saved regularly through Photoshop, the right image was saved via “export to web.” the difference in sizes comes from removal of meta data from the file."></p>
<h1 id="Pixel-format"><a href="#Pixel-format" class="headerlink" title="Pixel format"></a>Pixel format</h1><p>The PNG format can ALSO support various types of pixel formats so you can create an optimal</p>
<p>Indexed = 1 channel, can be 1,2,4,8 bpc</p>
<p>Grayscale = 1 channel, can be 1,2,4,8,16 bpc</p>
<p>Gray+Alpha = 2 channel, can be 8 or 16 bpc</p>
<p>Truecolor(RGB) = 3 channel, can be 8 or 16 bpc</p>
<p>RGBA = 4 channel, can be 8 or 16 bpc</p>
<p>Pixel formats are selected by the author of the image file. So it’s not too interesting to discuss, other than making sure you’ve chosen the right pixel format; Storing a greyscale image as a truecolor w/ alpha, is a bad idea.</p>
<h1 id="Story-GIF-and-the-birth-of-PNG"><a href="#Story-GIF-and-the-birth-of-PNG" class="headerlink" title="Story : GIF and the birth of PNG"></a>Story : GIF and the birth of PNG</h1><p>When it comes to the relentless bulk of web content, images are by far the largest load bearer today (although there’s an argument to be made that videos have become king as of late).</p>
<p>But what’s truly interesting is that as much as compression information can help solve some of the congestion, there’s a massive amount of human problems that keep compression from making its way into everyone’s hands.</p>
<p>Let’s take a trip back to 1985, when Unisys filed a patent for the LZW compression algorithm, nothing too interesting at the time. A few years later, when CompuServe invented the 89a format (which later became the GIF format), they used LZW as its backbone, not realizing that it was a patented. Unisys didn’t care about this until 1993, when the Netscape browser added support for the IMG HTML tag, alongside with support for the 89a format. Within a year, animated images became all the craze on the internet, and Unisys started enforcing its patent. CompuServe and Unisys eventually reached a court agreement in December of 1994, announcing that Unisys would start collecting royalties from all software that used the 89a graphics format. In the months following this decision, a group of engineers developed an entirely new, patent-free format known as the Portable Network Graphics or PNG format.</p>
<p>In 2004, the patent on LZW finally expired, but for a whole decade, the GIF/PNG image format debate was a hot one among internet folks.</p>
<h1 id="In-closing"><a href="#In-closing" class="headerlink" title="In closing"></a>In closing</h1><p>PNG is a very flexible and powerful image format type that’s become popular on the web due to it’s ability to support transparency. But it’s not right for <em>every</em> situation; Basically, make sure you’re using the best tool for the job. If your image is photographic and absolute losslessness is not required, then JPG or an equivalent lossy method would be more efficient than any lossless approach. On the other hand If you need a smaller bit-format, or need transparency, than PNG would be a dominant win over JPG.</p>
<p>And if you’re interested in seeing the most bare-bones implementation of a PNG coder, check out this awesome gist, which packs the whole thing into ~40 lines of code.</p>
<p>Of course, then there’s WebP, which will give you both.. But that’s another video ;)<br>CompressionAndroidPerformance<br>69</p>
</div><script type="text/javascript" src="/js/share.js?v=0.0.1" async></script><a data-url="http://androidperformance.com/2016/04/07/how-png-works.html" data-id="cj34kxh8c003n97zenkaxcl2a" class="article-share-link">分享</a><div class="tags"><a href="/tags/Android/">Android</a></div><div class="post-nav"><a href="/2016/04/05/android-bottom-bar-2.html" class="pre">Android Bottom navigation 规范二：样式、行为与规格</a><a href="/2016/04/19/Avoiding-cold-starts-on-Android.html" class="next">Avoiding cold starts on Android</a></div><div id="uyan_frame"></div><script type="text/javascript" src="http://v2.uyan.cc/code/uyan.js?uid=2131830"></script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://androidperformance.com"/></form></div><div class="widget"><div class="search-form"><input id="local-search-input" placeholder="Search" type="text" name="q" results="0"/><div id="local-search-result"></div></div></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Android/">Android</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Android/Github/">Github</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Android/Linux/">Linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Android/Menory/">Menory</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Android/Menory/Performance/">Performance</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Android/Performance/">Performance</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Android/Performance/翻译/">翻译</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Android/View/">View</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Android/性能优化/">性能优化</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Android/设计/">设计</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Android/设计/翻译/">翻译</a></li></ul></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/">Java</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/随笔/">随笔</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/随笔/2017/">2017</a></li></ul></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/hwui/" style="font-size: 15px;">hwui</a> <a href="/tags/随笔/" style="font-size: 15px;">随笔</a> <a href="/tags/MAT/" style="font-size: 15px;">MAT</a> <a href="/tags/Performance/" style="font-size: 15px;">Performance</a> <a href="/tags/Menory/" style="font-size: 15px;">Menory</a> <a href="/tags/启动优化/" style="font-size: 15px;">启动优化</a> <a href="/tags/DelayLoad/" style="font-size: 15px;">DelayLoad</a> <a href="/tags/Android/" style="font-size: 15px;">Android</a> <a href="/tags/RenderThread/" style="font-size: 15px;">RenderThread</a> <a href="/tags/Java/" style="font-size: 15px;">Java</a> <a href="/tags/Singleton/" style="font-size: 15px;">Singleton</a> <a href="/tags/设计规范/" style="font-size: 15px;">设计规范</a> <a href="/tags/HashMap/" style="font-size: 15px;">HashMap</a> <a href="/tags/Nexus/" style="font-size: 15px;">Nexus</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/05/15/Effective-java-for-Android.html">Effective java for Android[翻译]</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/04/23/About-work.html">关于 2017</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/04/19/Avoiding-cold-starts-on-Android.html">Avoiding cold starts on Android</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/04/07/how-png-works.html">How PNG Works</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/04/05/android-bottom-bar-2.html">Android Bottom navigation 规范二：样式、行为与规格</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/04/05/android-bottom-bar-1.html">Android Bottom navigation 规范一：使用方法</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/12/31/How-to-calculation-android-app-lunch-time.html">Android 中如何计算 App 的启动时间？</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/12/29/Android应用启动优化-一种DelayLoad的实现和原理-下篇.html">Android应用启动优化:一种DelayLoad的实现和原理(下篇)</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/11/18/Android-app-lunch-optimize-delay-load.html">Android应用启动优化:一种DelayLoad的实现和原理(上篇)</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/08/12/AndroidL-hwui-RenderThread-workflow.html">Android5.0中 hwui 中 RenderThread 工作流程</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://hexo.io" title="Hexo" target="_blank">Hexo</a><ul></ul><a href="https://pages.github.com/" title="GitHub" target="_blank">GitHub</a><ul></ul><a href="http://moxfive.xyz/" title="MOxFIVE" target="_blank">MOxFIVE</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2017 <a href="/." rel="nofollow">Performance.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.1" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.1" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.css"><script type="text/javascript" src="/js/search.js?v=0.0.1"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
   search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.1"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.1"></script></div></body></html>